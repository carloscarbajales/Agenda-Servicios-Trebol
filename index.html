<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Farmacias Trébol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SDK de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .sidebar-icon { transition: all 0.2s ease-in-out; }
        .sidebar-icon:hover { background-color: #374151; transform: scale(1.1); }
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; max-width: 320px; }
        .notification.show { opacity: 1; }
        .notification.success { background-color: #10B981; }
        .notification.error { background-color: #EF4444; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Pantalla de Login -->
    <div id="login-view" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">Farmacias Trébol</h2>
                <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">Inicia sesión para acceder al panel</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div>
                    <input id="email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Email de acceso">
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Contraseña">
                </div>
                <p id="login-error" class="text-red-500 text-sm mt-2"></p>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Acceder</button>
            </form>
        </div>
    </div>

    <!-- Aplicación Principal -->
    <div id="app-view" class="hidden">
        <div class="flex h-screen bg-gray-200 dark:bg-gray-800">
            <!-- Barra lateral -->
            <div class="w-16 bg-gray-900 flex flex-col items-center py-4 space-y-6">
                <div class="text-indigo-400 font-bold text-lg">FT</div>
                <a href="#" data-view="dashboard" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg></a>
                <a href="#" data-view="calendar" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Calendario"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg></a>
                <a href="#" data-view="appointments" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Gestión de Citas"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg></a>
                <a href="#" data-view="services" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white role-gerente role-gestor" title="Servicios"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15 1"/><path d="m9 11 4 4"/><path d="M5 19l-3 3"/></svg></a>
                <a href="#" data-view="objectives" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Objetivos"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></a>
                <a href="#" data-view="reports" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white role-gerente role-gestor" title="Informes"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m16 14-3-3-2 2-3-3"/></svg></a>
                <a href="#" data-view="config" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white role-gerente role-gestor" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.4l.15.08a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></a>
                <div class="mt-auto"><a href="#" id="logout-button" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Cerrar Sesión"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></a></div>
            </div>

            <!-- Contenido Principal -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 shadow">
                    <h1 id="view-title" class="text-2xl font-bold">Dashboard</h1>
                    <div id="user-info" class="text-right">
                        <p class="font-semibold" id="user-name"></p>
                        <p class="text-sm text-gray-500" id="user-role"></p>
                    </div>
                </header>
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6">
                    <div id="dashboard-view" class="view active">...</div>
                    <div id="calendar-view" class="view">...</div>
                    <div id="appointments-view" class="view">...</div>
                    <div id="services-view" class="view">...</div>
                    <div id="objectives-view" class="view">...</div>
                    <div id="reports-view" class="view">...</div>
                    <div id="config-view" class="view">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <!-- Columna de Gestión de Empleados y Email -->
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow space-y-6">
                                <div class="role-gerente role-gestor">
                                    <h3 class="font-bold">Email Central de Gestión</h3>
                                    <form id="config-central-email-form" class="flex gap-4 items-center">
                                        <input id="central-email" type="email" placeholder="gestion.trebol@gmail.com" required class="flex-grow p-2 rounded bg-gray-200 dark:bg-gray-700">
                                        <button type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Guardar</button>
                                    </form>
                                </div>
                                <div class="role-gerente role-gestor">
                                    <h3 class="font-bold mt-4">Gestión de Empleados y Gerentes</h3>
                                    <form id="create-employee-form" class="space-y-4">
                                        <input type="text" id="employee-username" placeholder="Nombre de usuario (ej: juan.perez)" required class="w-full p-2 rounded bg-gray-200 dark:bg-gray-700">
                                        <select id="employee-role" required class="w-full p-2 rounded bg-gray-200 dark:bg-gray-700">
                                            <option value="empleado">Empleado</option>
                                            <option value="gerente" class="role-gestor">Gerente</option>
                                        </select>
                                        <select id="employee-pharmacy" required class="w-full p-2 rounded bg-gray-200 dark:bg-gray-700">
                                            <option value="">Seleccionar farmacia...</option>
                                        </select>
                                        <button type="submit" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">Crear Usuario</button>
                                    </form>
                                </div>
                            </div>
                            <!-- Columna de Gestión de Farmacias (solo para gestor) -->
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow space-y-6 role-gestor">
                                <div>
                                    <h3 class="font-bold">Gestión de Farmacias</h3>
                                     <form id="create-pharmacy-form" class="space-y-4 mt-4">
                                        <input type="text" id="pharmacy-name" placeholder="Nombre de la nueva farmacia" required class="w-full p-2 rounded bg-gray-200 dark:bg-gray-700">
                                        <input type="text" id="pharmacy-address" placeholder="Dirección (opcional)" class="w-full p-2 rounded bg-gray-200 dark:bg-gray-700">
                                        <button type="submit" class="w-full bg-purple-600 text-white p-2 rounded hover:bg-purple-700">Crear Farmacia</button>
                                    </form>
                                </div>
                                <div class="mt-6">
                                    <h3 class="font-bold">Farmacias Existentes</h3>
                                    <ul id="pharmacies-list" class="mt-2 space-y-2">
                                        <!-- La lista se llenará dinámicamente -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <div id="notification-container"></div>

    <script type="module">
        /*
        --------------------------------------------------------------------------
        --- ¡ACCIÓN URGENTE REQUERIDA! CORRECCIÓN DE ERROR DE BASE DE DATOS ---
        --------------------------------------------------------------------------
        ¡Hola! El error "stack depth limit exceeded" que estás viendo no es un fallo
        del código de esta página, sino un problema de recursión infinita en las
        reglas de seguridad de la base de datos que te proporcioné en el paso anterior.

        Pido disculpas por el error. La buena noticia es que tiene una solución sencilla.

        ¿QUÉ HA PASADO?
        Las reglas de seguridad intentan leer el "rol" del usuario para ver si tiene
        permiso, pero para leer el "rol", necesitan aplicar las reglas de seguridad.
        Esto crea un bucle infinito (Regla -> Leer Rol -> Regla -> Leer Rol...).

        ¿CÓMO SOLUCIONARLO?
        Necesitas reemplazar las funciones y políticas que crean este bucle. Por favor,
        sigue estos dos pasos en el SQL Editor de tu proyecto de Supabase:

        PASO 1: BORRA LAS POLÍTICAS Y FUNCIONES ANTIGUAS
        Ejecuta este script para limpiar las reglas incorrectas. Es seguro hacerlo.

        DROP POLICY IF EXISTS "Los usuarios pueden ver los perfiles relevantes" ON public.users;
        DROP POLICY IF EXISTS "Los administradores pueden crear perfiles de usuario" ON public.users;
        DROP POLICY IF EXISTS "Cualquier usuario autenticado puede leer la configuración" ON public.config;
        DROP POLICY IF EXISTS "Los administradores pueden actualizar la configuración" ON public.config;
        DROP POLICY IF EXISTS "Los gestores pueden gestionar todas las farmacias" ON public.pharmacies;
        DROP POLICY IF EXISTS "Gerentes y empleados pueden ver su propia farmacia" ON public.pharmacies;
        DROP FUNCTION IF EXISTS get_my_role();
        DROP FUNCTION IF EXISTS get_my_pharmacy_id();


        PASO 2: CREA LAS NUEVAS FUNCIONES Y POLÍTICAS CORREGIDAS
        Ahora, ejecuta este script completo. Utiliza una técnica segura (SECURITY DEFINER)
        para evitar el bucle infinito.

        -- Crear funciones que evitan el bucle de RLS de forma segura
        CREATE OR REPLACE FUNCTION get_my_role()
        RETURNS TEXT LANGUAGE plpgsql SECURITY DEFINER AS $$
        BEGIN
          RETURN (SELECT role FROM public.users WHERE id = auth.uid());
        END;
        $$;

        CREATE OR REPLACE FUNCTION get_my_pharmacy_id()
        RETURNS INT LANGUAGE plpgsql SECURITY DEFINER AS $$
        BEGIN
          RETURN (SELECT pharmacy_id FROM public.users WHERE id = auth.uid());
        END;
        $$;

        -- Volver a crear las políticas usando las funciones seguras
        -- Políticas para la tabla 'users'
        CREATE POLICY "Usuarios pueden ver perfiles relevantes" ON public.users FOR SELECT USING (
            id = auth.uid() OR -- Un usuario puede ver su propio perfil
            get_my_role() = 'gestor' OR -- Un gestor puede ver todos los perfiles
            (get_my_role() = 'gerente' AND pharmacy_id = get_my_pharmacy_id()) -- Un gerente puede ver los perfiles de su farmacia
        );
        CREATE POLICY "Administradores pueden crear perfiles de usuario" ON public.users FOR INSERT WITH CHECK (
            get_my_role() IN ('gerente', 'gestor') AND
            (get_my_role() = 'gestor' OR pharmacy_id = get_my_pharmacy_id())
        );

        -- Políticas para la tabla 'config'
        CREATE POLICY "Cualquier usuario autenticado puede leer la configuración" ON public.config FOR SELECT USING (auth.uid() IS NOT NULL);
        CREATE POLICY "Administradores pueden actualizar la configuración" ON public.config FOR UPDATE USING (get_my_role() IN ('gerente', 'gestor'));

        -- Políticas para la tabla 'pharmacies'
        CREATE POLICY "Gestores pueden gestionar todas las farmacias" ON public.pharmacies FOR ALL USING (get_my_role() = 'gestor');
        CREATE POLICY "Personal puede ver su propia farmacia" ON public.pharmacies FOR SELECT USING (id = get_my_pharmacy_id());

        --------------------------------------------------------------------------
        Una vez que ejecutes estos dos scripts, recarga la página. ¡El error habrá desaparecido!
        --------------------------------------------------------------------------
        */
        const { createClient } = supabase;

        // --- CONFIGURACIÓN DE SUPABASE ---
        const SUPABASE_URL = 'https://whwhdifunboeehfispum.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indod2hkaWZ1bmJvZWVoZmlzcHVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTU2NjMsImV4cCI6MjA3NjYzMTY2M30.kOZGKXOMyhmzbTezNutKhwQ50Cn3uDFulNASax1sQR8';

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ESTADO DE LA APLICACIÓN ---
        let currentUser = null;
        let userData = { role: 'empleado', pharmacy_id: null };
        let centralEmail = null;
        let managedPharmacies = [];

        // --- ELEMENTOS DEL DOM ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        const createEmployeeForm = document.getElementById('create-employee-form');
        const configCentralEmailForm = document.getElementById('config-central-email-form');
        const centralEmailInput = document.getElementById('central-email');
        const createPharmacyForm = document.getElementById('create-pharmacy-form');
        const notificationContainer = document.getElementById('notification-container');
        
        // --- FUNCIÓN DE NOTIFICACIONES ---
        const showNotification = (message, type = 'success') => {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        };

        // --- LÓGICA DE GESTIÓN DE FARMACIAS ---
        const loadPharmacies = async () => {
            try {
                const { data, error } = await supabaseClient.from('pharmacies').select('*');
                if (error) throw error;

                managedPharmacies = data;
                
                // Renderizar lista para el gestor
                const pharmaciesList = document.getElementById('pharmacies-list');
                pharmaciesList.innerHTML = managedPharmacies.map(p => `<li class="p-2 bg-gray-100 dark:bg-gray-700 rounded">${p.name}</li>`).join('');

                // Llenar el dropdown para crear empleados
                const employeePharmacySelect = document.getElementById('employee-pharmacy');
                employeePharmacySelect.innerHTML = '<option value="">Seleccionar farmacia...</option>'; // Reset
                let pharmaciesForDropdown = [];

                if (userData.role === 'gestor') {
                    pharmaciesForDropdown = managedPharmacies;
                } else if (userData.role === 'gerente' && userData.pharmacy_id) {
                    const myPharmacy = managedPharmacies.find(p => p.id === userData.pharmacy_id);
                    if (myPharmacy) pharmaciesForDropdown = [myPharmacy];
                }
                
                pharmaciesForDropdown.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = p.name;
                    employeePharmacySelect.appendChild(option);
                });

                if (userData.role === 'gerente') employeePharmacySelect.value = userData.pharmacy_id;

            } catch (error) {
                 console.error("Error cargando farmacias:", error.message);
                 if (error.message.includes('depth limit exceeded') || error.message.includes('recursion')) {
                    showNotification("¡Error Grave! Bucle de permisos detectado en la BD. Sigue las instrucciones en los comentarios del código.", "error");
                } else {
                    showNotification("No se pudieron cargar las farmacias.", "error");
                }
            }
        };

        createPharmacyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('pharmacy-name').value.trim();
            const address = document.getElementById('pharmacy-address').value.trim();
            if (!name) {
                showNotification("El nombre de la farmacia es obligatorio.", "error");
                return;
            }

            const { error } = await supabaseClient.from('pharmacies').insert({ name, address });
            if (error) {
                showNotification("Error al crear la farmacia.", "error");
                console.error("Error creando farmacia:", error.message);
            } else {
                showNotification("Farmacia creada con éxito.", "success");
                createPharmacyForm.reset();
                await loadPharmacies(); // Recargar la lista
            }
        });

        // --- LÓGICA DE CONFIGURACIÓN ---
        const loadConfig = async () => {
            const { data, error } = await supabaseClient.from('config').select('central_email').eq('id', 1).single();
            if (error) {
                console.error("Error cargando configuración:", error.message);
            } else if (data) {
                centralEmail = data.central_email;
                if (centralEmail) centralEmailInput.value = centralEmail;
            }
        };

        configCentralEmailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newEmail = centralEmailInput.value.trim();
            const { error } = await supabaseClient.from('config').update({ central_email: newEmail }).eq('id', 1);
            if (error) {
                showNotification("Error al guardar el email. Revisa tus permisos.", "error");
            } else {
                centralEmail = newEmail;
                showNotification("Email central guardado.", "success");
            }
        });

        // --- LÓGICA DE AUTENTICACIÓN ---
        const checkUserSession = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                try {
                    const { data, error } = await supabaseClient.from('users').select('*').eq('id', currentUser.id).single();

                    if (error) throw error; 

                    if (!data) {
                         userData = { role: 'empleado' }; // Rol por defecto si no hay perfil
                    } else {
                        userData = data;
                    }

                    await loadConfig();
                    setupUIForUser();
                    if(userData.role === 'gestor' || userData.role === 'gerente') await loadPharmacies();
                    
                    loginView.style.display = 'none';
                    appView.style.display = 'block';

                } catch(error) {
                    console.error("Error crítico al iniciar sesión:", error.message);
                    if (error.message.includes('depth limit exceeded') || error.message.includes('recursion')) {
                        showNotification("¡Error Grave! Bucle de permisos detectado en la BD. Sigue las instrucciones en los comentarios del código para solucionarlo.", "error");
                    } else {
                        showNotification("Error al obtener el perfil de usuario. Contacta al administrador.", "error");
                    }
                    await supabaseClient.auth.signOut();
                }

            } else {
                loginView.style.display = 'flex';
                appView.style.display = 'none';
            }
        };

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.textContent = '';
            const { error } = await supabaseClient.auth.signInWithPassword({ email: loginForm.email.value, password: loginForm.password.value });
            if (error) {
                loginError.textContent = 'Email o contraseña incorrectos.';
            } else {
                checkUserSession();
            }
        });

        logoutButton.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.reload();
        });

        // --- LÓGICA DE GESTIÓN DE EMPLEADOS ---
        createEmployeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('employee-username').value.trim().toLowerCase().replace(/\s+/g, '.');
            const role = document.getElementById('employee-role').value;
            const pharmacy_id = document.getElementById('employee-pharmacy').value;

            if (!username || !role || !pharmacy_id) { showNotification("Todos los campos son obligatorios.", "error"); return; }
            if (!centralEmail) { showNotification("Guarda un email central válido primero.", "error"); return; }
            
            const [base, domain] = centralEmail.split('@');
            const email = `${base}+${username}@${domain}`;
            const password = Math.random().toString(36).slice(-10) + "A1!";

            const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
            if (authError) {
                showNotification(authError.message, "error");
                return;
            }

            if (authData.user) {
                const { error: profileError } = await supabaseClient
                    .from('users')
                    .insert({ id: authData.user.id, role, username, email, pharmacy_id });
                
                if (profileError) {
                    showNotification("Usuario creado en auth, pero no se pudo guardar su perfil.", "error");
                } else {
                    showNotification(`Usuario ${username} (${role}) creado con éxito.`, "success");
                    await supabaseClient.auth.resetPasswordForEmail(email);
                    createEmployeeForm.reset();
                    if(userData.role === 'gerente') document.getElementById('employee-pharmacy').value = userData.pharmacy_id;
                }
            }
        });

        // --- LÓGICA DE UI ---
        const setupUIForUser = () => {
            document.getElementById('user-name').textContent = currentUser.email;
            document.getElementById('user-role').textContent = `Rol: ${userData.role}`;
            document.querySelectorAll('.role-gerente, .role-gestor').forEach(el => el.style.display = 'none');
            
            if (userData.role === 'gerente') {
                document.querySelectorAll('.role-gerente').forEach(el => el.style.display = 'block');
            }
            if (userData.role === 'gestor') {
                document.querySelectorAll('.role-gerente, .role-gestor').forEach(el => el.style.display = 'block');
                document.querySelector('#employee-role option[value="gerente"]').style.display = 'block';
            }
        };

        document.querySelectorAll('.sidebar-icon').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const viewId = e.currentTarget.dataset.view;
                document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id === `${viewId}-view`));
                document.getElementById('view-title').textContent = e.currentTarget.getAttribute('title');
            });
        });

        // --- INICIALIZACIÓN ---
        checkUserSession();
    </script>
</body>
</html>

