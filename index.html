<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Farmacias Trébol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SDK de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .view { display: none; }
        .view.active { display: block; }
        .sidebar-icon { transition: all 0.2s ease-in-out; }
        .sidebar-icon:hover { background-color: #374151; transform: scale(1.1); }
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem; color: white; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; max-width: 320px; }
        .notification.show { opacity: 1; }
        .notification.success { background-color: #10B981; }
        .notification.error { background-color: #EF4444; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        /* Clases para ocultar/mostrar elementos por rol */
        .role-empleado, .role-gerente, .role-gestor, .role-administrador { display: none; }
        /* Estilo para inputs deshabilitados */
        input:disabled, select:disabled {
             background-color: #e5e7eb; /* gray-200 */
             cursor: not-allowed;
         }
         .dark input:disabled, .dark select:disabled {
              background-color: #4b5563; /* gray-600 */
          }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Pantalla de Login -->
    <div id="login-view" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">Farmacias Trébol</h2>
                <p class="mt-2 text-center text-sm text-gray-600 dark:text-gray-400">Inicia sesión</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div>
                    <input id="login-identifier" name="identifier" type="text" autocomplete="username" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Usuario o Email de acceso">
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Contraseña">
                </div>
                <div class="flex items-center justify-between">
                    <div class="text-sm">
                        <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                            ¿Has olvidado tu contraseña?
                        </a>
                    </div>
                </div>
                <p id="login-error" class="text-red-500 text-sm mt-2"></p>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Acceder</button>
            </form>
        </div>
    </div>
    
    <!-- Modal para restablecer contraseña -->
    <div id="reset-password-modal" class="modal">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg relative">
            <button id="close-modal-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200 text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold text-center">Restablecer Contraseña</h2>
            <p class="text-center text-sm text-gray-600 dark:text-gray-400">Introduce tu nombre de usuario o email. Se enviará un enlace de recuperación.</p>
            <form id="reset-password-form" class="space-y-4">
                <input id="reset-identifier-input" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700" placeholder="Usuario o Email">
                <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Enviar enlace</button>
            </form>
        </div>
    </div>
    
    <!-- Modal para actualizar la contraseña (usado por el link de recuperación) -->
    <div id="update-password-modal" class="modal">
        <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-center">Elige tu Nueva Contraseña</h2>
            <form id="update-password-form" class="space-y-4">
                <input id="new-password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700" placeholder="Nueva contraseña">
                <input id="confirm-password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700" placeholder="Confirmar nueva contraseña">
                <p id="update-password-error" class="text-red-500 text-sm"></p>
                <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Guardar Contraseña</button>
            </form>
        </div>
    </div>


    <!-- Aplicación Principal -->
    <div id="app-view" class="hidden">
        <div class="flex h-screen bg-gray-200 dark:bg-gray-800">
            <!-- Barra lateral -->
            <div class="w-16 bg-gray-900 flex flex-col items-center py-4 space-y-6">
                <div class="text-indigo-400 font-bold text-lg">FT</div>
                <a href="#" data-view="dashboard" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Dashboard"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg></a>
                <a href="#" data-view="calendar" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Calendario"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg></a>
                <a href="#" data-view="appointments" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Gestión de Citas"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg></a>
                <!-- Ocultar servicios si no es al menos gerente -->
                <a href="#" data-view="services" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white role-gerente role-gestor role-administrador" title="Servicios"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 2 4 4"/><path d="m17 7 3-3"/><path d="M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15 1"/><path d="m9 11 4 4"/><path d="M5 19l-3 3"/></svg></a>
                <a href="#" data-view="objectives" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Objetivos"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></a>
                <!-- Ocultar informes y config si no es al menos gerente -->
                <a href="#" data-view="reports" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white role-gerente role-gestor role-administrador" title="Informes"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m16 14-3-3-2 2-3-3"/></svg></a>
                <a href="#" data-view="config" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white role-gerente role-gestor role-administrador" title="Configuración"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.4l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.4l.15.08a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg></a>
                
                <div class="mt-auto flex flex-col items-center space-y-6">
                    <!-- Botón Mi Perfil -->
                    <a href="#" data-view="profile" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Mi Perfil">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </a>
                    <a href="#" id="logout-button" class="sidebar-icon p-2 rounded-lg text-gray-400 hover:text-white" title="Cerrar Sesión">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    </a>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 shadow">
                    <h1 id="view-title" class="text-2xl font-bold">Dashboard</h1>
                    <div id="user-info" class="text-right">
                        <p class="font-semibold" id="user-display-name"></p> 
                        <p class="text-sm text-gray-500" id="user-role"></p>
                    </div>
                </header>
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6">
                    <div id="dashboard-view" class="view active">
                         <h2 class="text-xl font-semibold mb-4">Bienvenido</h2>
                         <p>Selecciona una opción del menú lateral.</p>
                    </div>
                    <div id="calendar-view" class="view">
                         <h2 class="text-xl font-semibold mb-4">Calendario</h2>
                         <p>(Pendiente)</p>
                    </div>
                    <div id="appointments-view" class="view">
                         <h2 class="text-xl font-semibold mb-4">Gestión de Citas</h2>
                         <p>(Pendiente)</p>
                    </div>
                    <div id="services-view" class="view role-gerente role-gestor role-administrador">
                         <h2 class="text-xl font-semibold mb-4">Servicios</h2>
                         <p>(Pendiente)</p>
                    </div>
                    <div id="objectives-view" class="view">
                         <h2 class="text-xl font-semibold mb-4">Objetivos</h2>
                         <p>(Pendiente)</p>
                    </div>
                    <div id="reports-view" class="view role-gerente role-gestor role-administrador">
                         <h2 class="text-xl font-semibold mb-4">Informes</h2>
                         <p>(Pendiente)</p>
                    </div>
                    
                    <!-- Vista de Perfil de Usuario -->
                    <div id="profile-view" class="view">
                         <div class="max-w-xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                             <h2 class="text-2xl font-bold mb-6">Mi Perfil</h2>
                             <div class="space-y-4 mb-8">
                                 <p><strong>Usuario:</strong> <span id="profile-username">Cargando...</span></p>
                                 <p><strong>Email:</strong> <span id="profile-email">Cargando...</span></p>
                                 <p><strong>Rol:</strong> <span id="profile-role">Cargando...</span></p>
                             </div>
                             
                             <h3 class="text-xl font-bold border-t pt-6 border-gray-200 dark:border-gray-700">Cambiar Contraseña</h3>
                             <p class="text-sm text-gray-500 mb-4">Introduce una nueva contraseña para tu cuenta.</p>
                             <form id="change-password-form" class="space-y-4">
                                 <input id="change-new-password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700" placeholder="Nueva contraseña">
                                 <input id="change-confirm-password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-700" placeholder="Confirmar nueva contraseña">
                                 <p id="change-password-error" class="text-red-500 text-sm"></p>
                                 <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Actualizar Contraseña</button>
                             </form>
                         </div>
                    </div>

                    <!-- Vista de Configuración (Simplificada) -->
                    <div id="config-view" class="view role-gerente role-gestor role-administrador">
                         <h2 class="text-xl font-semibold mb-4">Configuración</h2>
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow space-y-6">
                            <!-- Creación de usuarios (Simplificado: Solo Empleado, sin farmacia) -->
                            <div class="role-gerente role-gestor role-administrador">
                                <h3 class="font-bold">Crear Nuevo Empleado (Temporal)</h3>
                                 <p class="text-sm text-gray-500 mb-4">Por ahora, solo se pueden crear usuarios con rol 'empleado' y sin asignar farmacia. Usa tu email real para pruebas.</p>
                                <form id="create-user-form" class="space-y-4">
                                    <input type="text" id="new-username" placeholder="Nombre de usuario (ej: juan.perez)" required class="w-full p-2 rounded bg-gray-200 dark:bg-gray-700 border">
                                    <input type="email" id="new-email" placeholder="Email del empleado" required class="w-full p-2 rounded bg-gray-200 dark:bg-gray-700 border">
                                    <!-- Rol fijado a empleado por ahora -->
                                    <input type="hidden" id="new-role" value="empleado">
                                    <button type="submit" class="w-full bg-green-600 text-white p-2 rounded hover:bg-green-700">Crear Empleado</button>
                                </form>
                            </div>
                            <!-- Más opciones de configuración irán aquí -->
                         </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <div id="notification-container"></div>

    <script type="module">
        const { createClient } = supabase;

        // --- CONFIGURACIÓN DE SUPABASE ---
        const SUPABASE_URL = 'https://pglnmsqqdcjvzhbvxfvb.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBnbG5tc3FxZGNqdnpoYnZ4ZnZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNjEyNTMsImV4cCI6MjA3NjczNzI1M30.Y9oTGPPcm9X9Ml2thYCZVs1lwVIbX83X_CNRLYcHPdQ';

        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ESTADO DE LA APLICACIÓN ---
        let currentUser = null;
        let userData = { role: 'empleado' }; // Rol por defecto inicial

        // --- ELEMENTOS DEL DOM ---
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        const notificationContainer = document.getElementById('notification-container');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const updatePasswordModal = document.getElementById('update-password-modal');
        const updatePasswordForm = document.getElementById('update-password-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const userDisplayName = document.getElementById('user-display-name'); 
        const userRoleDisplay = document.getElementById('user-role');
        const createUserForm = document.getElementById('create-user-form'); 
        
        // --- FUNCIÓN DE NOTIFICACIONES ---
        const showNotification = (message, type = 'success') => { /*...*/ }; // Sin cambios
        
        // --- VISTAS GLOBALES ---
        const showAppView = () => { /*...*/ }; // Sin cambios
        const showLoginView = () => { /*...*/ }; // Sin cambios

        // --- PRUEBA DE CONECTIVIDAD INICIAL ---
        (async () => {
            try {
                console.log("[DEBUG] Performing basic connectivity check...");
                // Intentar leer la tabla 'users' (que debería existir) con un límite muy pequeño
                const { error } = await supabaseClient.from('users').select('id').limit(1); 
                
                // Si el error es específicamente 'Failed to fetch', es un problema de conexión
                if (error && error.message.toLowerCase().includes('failed to fetch')) {
                     console.error("[FATAL DEBUG] Connectivity check FAILED: Failed to fetch. Check Supabase URL/Key/Project Status/Network.");
                     loginError.textContent = "Error CRÍTICO: No se puede conectar al servidor. Verifica URL/Clave o si el proyecto está activo.";
                     loginForm.querySelector('button[type="submit"]').disabled = true; // Deshabilitar botón de login
                } else if (error && error.code === 'PGRST116') { // Error esperado si la tabla 'users' está vacía o sin RLS de lectura aún
                     console.log("[DEBUG] Connectivity check OK (received expected 'No rows found' error or similar).");
                } else if (error) { // Otro tipo de error durante la comprobación
                    console.warn("[DEBUG] Connectivity check returned an unexpected error (but not 'Failed to fetch'):", error.message);
                    // Podría ser un error de RLS si la regla de lectura no está bien, pero la conexión funciona
                    loginError.textContent = `Advertencia: Error (${error.code}) al verificar conexión. Revisa reglas SQL.`;
                } else { // No hubo error, conexión OK
                     console.log("[DEBUG] Connectivity check OK.");
                }
            } catch (fetchError) { // Capturar excepción si 'fetch' falla catastróficamente
                 console.error("[FATAL DEBUG] Connectivity check THREW Exception:", fetchError);
                 loginError.textContent = "Error CRÍTICO: Fallo general de conexión. Revisa URL/Clave/Estado del Proyecto.";
                 if (loginForm) { // Asegurarse que el form existe
                    const loginButton = loginForm.querySelector('button[type="submit"]');
                    if (loginButton) loginButton.disabled = true; 
                 }
            }
        })();
        // --- FIN PRUEBA DE CONECTIVIDAD ---


        // --- LÓGICA DE AUTENTICACIÓN Y SESIÓN ---
        const initializeApp = async (session) => { /*...*/ }; // Sin cambios
        loginForm.addEventListener('submit', async (e) => { /*...*/ }); // Sin cambios
        logoutButton.addEventListener('click', async (e) => { /*...*/ }); // Sin cambios

        // --- LÓGICA DE RESTABLECIMIENTO DE CONTRASEÑA ---
        forgotPasswordLink.addEventListener('click', (e) => { /*...*/ }); // Sin cambios
        closeModalButton.addEventListener('click', () => { /*...*/ }); // Sin cambios
        resetPasswordForm.addEventListener('submit', async (e) => { /*...*/ }); // Sin cambios
        updatePasswordForm.addEventListener('submit', async (e) => { /*...*/ }); // Sin cambios
        changePasswordForm.addEventListener('submit', async (e) => { /*...*/ }); // Sin cambios


       // --- LÓGICA DE CREACIÓN DE USUARIOS (Simplificada) ---
         if (createUserForm) { createUserForm.addEventListener('submit', async (e) => { /*...*/ }); } // Sin cambios
        
        // --- LÓGICA DE UI ---
        const setupUIForUser = () => { /*...*/ }; // Sin cambios

        // --- NAVEGACIÓN ---
        document.querySelectorAll('.sidebar-icon').forEach(link => { /*...*/ }); // Sin cambios

        // --- INICIALIZACIÓN Y MANEJO DE ESTADO DE AUTENTICACIÓN ---
        supabaseClient.auth.onAuthStateChange(async (event, session) => { /*...*/ }); // Sin cambios

    </script>
</body>
</html>

